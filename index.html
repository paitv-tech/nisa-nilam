<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NISA - NILAM Integrated Smart App</title>
    
        <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <meta name="theme-color" content="#8e008b">
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
          .then(() => console.log('‚úÖ Service Worker registered'))
          .catch(err => console.error('‚ùå Service Worker failed:', err));
      }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2e005d 0%, #5c008b 50%, #8e008b 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 4em;
            background: linear-gradient(45deg, #ff8300, #ff6200);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            color: #e6e6e6;
        }

        .main-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 20px;
            border: none;
            border-radius: 20px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-dashboard {
            background: linear-gradient(45deg, #ff8300, #ff6200);
            color: white;
        }

        .btn-add {
            background: linear-gradient(45deg, #8e008b, #5c008b);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-step {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .wizard-step h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #ff8300;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .step-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: #ff8300;
            transform: scale(1.2);
        }

        .step-dot.completed {
            background: #8e008b;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e6e6e6;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            background: rgba(255,255,255,0.9);
            color: #333;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(255,131,0,0.5);
            transform: scale(1.02);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-option {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-option:hover {
            background: rgba(255,131,0,0.3);
            border-color: #ff8300;
        }

        .btn-option.selected {
            background: #ff8300;
            border-color: #ff8300;
            transform: scale(1.05);
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn-nav {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-prev {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-next {
            background: #ff8300;
            color: white;
        }

        .btn-nav:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ff8300;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .ranking-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            background: rgba(255,131,0,0.2);
            transform: translateX(5px);
        }

        .ranking-position {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ff8300;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .ranking-position.gold {
            background: #FFD700;
            color: #333;
        }

        .ranking-position.silver {
            background: #C0C0C0;
            color: #333;
        }

        .ranking-position.bronze {
            background: #CD7F32;
            color: white;
        }

        .student-info {
            flex: 1;
            margin-left: 15px;
        }

        .student-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .student-class {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .book-count {
            font-size: 1.3em;
            font-weight: bold;
            color: #ff8300;
        }

        .back-button {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    color: white;
    font-size: 1.6em;
    cursor: pointer;
    backdrop-filter: blur(10px);
    z-index: 1000;
    transition: all 0.3s ease;
}

.back-button:hover {
    background: rgba(255,131,0,0.3);
    transform: translateX(-50%) scale(1.1);
}


        .loading {
            text-align: center;
            padding: 50px;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid #ff8300;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: rgba(0,255,0,0.2);
            border: 1px solid rgba(0,255,0,0.5);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #90EE90;
        }

        .error-message {
            background: rgba(255,0,0,0.2);
            border: 1px solid rgba(255,0,0,0.5);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #FFB6C1;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .btn {
                font-size: 1.1em;
                padding: 18px;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="header">
                <h1>NISA</h1>
                <p>NILAM Integrated Smart App</p>
            </div>
            
            <div class="main-buttons">
                <button class="btn btn-dashboard" onclick="loadDashboard()">
                    üìä Dashboard
                </button>
                <button class="btn btn-add" onclick="startWizard()">
                    üìò Tambah Bacaan
                </button>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <button class="back-button" onclick="showHome()">‚Üê</button>
            
            <div class="header">
                <h1>Dashboard</h1>
                <p>Statistik Bacaan NILAM</p>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalBooks">0</div>
                    <div class="stat-label">Jumlah Buku</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Jumlah Murid</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClasses">0</div>
                    <div class="stat-label">Jumlah Kelas</div>
                </div>
            </div>

            <div class="ranking-section">
                <h2>üèÜ Ranking Pembaca Terbaik</h2>
                <div id="rankingList"></div>
            </div>

            <div class="ranking-section">
                <h2>üìö Senarai Mengikut Kelas</h2>
                <div id="classList"></div>
            </div>
        </div>

        <!-- Wizard Page -->
        <div id="wizard" class="page">
            <button class="back-button" onclick="showHome()">‚Üê</button>
            
            <div class="step-indicator">
                <div class="step-dot active" id="step1">1</div>
                <div class="step-dot" id="step2">2</div>
                <div class="step-dot" id="step3">3</div>
                <div class="step-dot" id="step4">4</div>
            </div>

            <!-- Step 1: Pilih Tahun -->
            <div id="wizardStep1" class="wizard-step">
                <h2>Pilih Tahun</h2>
                <div class="btn-group">
                    <div class="btn-option" onclick="selectYear(1)">Tahun 1</div>
                    <div class="btn-option" onclick="selectYear(2)">Tahun 2</div>
                    <div class="btn-option" onclick="selectYear(3)">Tahun 3</div>
                    <div class="btn-option" onclick="selectYear(4)">Tahun 4</div>
                    <div class="btn-option" onclick="selectYear(5)">Tahun 5</div>
                    <div class="btn-option" onclick="selectYear(6)">Tahun 6</div>
                </div>
            </div>

            <!-- Step 2: Pilih Kelas -->
            <div id="wizardStep2" class="wizard-step" style="display: none;">
                <h2>Pilih Kelas</h2>
                <div class="btn-group">
                    <div class="btn-option" onclick="selectClass('SIGMA')">SIGMA</div>
                    <div class="btn-option" onclick="selectClass('BETA')">BETA</div>
                    <div class="btn-option" onclick="selectClass('ALPHA')">ALPHA</div>
                    <div class="btn-option" onclick="selectClass('KRIPTON')">KRIPTON</div>
                    <div class="btn-option" onclick="selectClass('NEON')">NEON</div>
                    <div class="btn-option" onclick="selectClass('HELIUM')">HELIUM</div>
                </div>
            </div>

            <!-- Step 3: Pilih Nama Murid -->
            <div id="wizardStep3" class="wizard-step" style="display: none;">
                <h2>Pilih Nama Murid</h2>
                <div class="form-group">
                    <label for="studentSelect">Nama Murid:</label>
                    <select id="studentSelect" onchange="selectStudent()">
                        <option value="">-- Pilih Murid --</option>
                    </select>
                </div>
            </div>

            <!-- Step 4: Isi Maklumat Buku -->
            <div id="wizardStep4" class="wizard-step" style="display: none;">
                <h2>Maklumat Buku</h2>
                <div class="form-group">
                    <label for="bookTitle">Tajuk Buku:</label>
                    <input type="text" id="bookTitle" placeholder="Masukkan tajuk buku">
                </div>
                <div class="form-group">
                    <label for="bookAuthor">Pengarang:</label>
                    <input type="text" id="bookAuthor" placeholder="Masukkan nama pengarang">
                </div>
                <div class="form-group">
                    <label for="bookCategory">Kategori:</label>
                    <select id="bookCategory">
                        <option value="">-- Pilih Kategori --</option>
                        <option value="Fiksyen">Fiksyen</option>
                        <option value="Bukan Fiksyen">Bukan Fiksyen</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="readingDate">Tarikh Bacaan:</label>
                    <input type="date" id="readingDate">
                </div>
                <div class="form-group">
                    <label for="bookReview">Ulasan / Sinopsis:</label>
                    <textarea id="bookReview" rows="4" placeholder="Tulis ulasan atau sinopsis buku"></textarea>
                </div>
                <button class="btn btn-add" onclick="submitReading()" style="width: 100%; margin-top: 20px;">
                    ‚úÖ Hantar Bacaan
                </button>
            </div>

            <div class="navigation-buttons">
                <button class="btn-nav btn-prev" onclick="previousStep()" id="prevBtn" style="display: none;">
                    ‚Üê Sebelum
                </button>
                <button class="btn-nav btn-next" onclick="nextStep()" id="nextBtn" style="display: none;">
                    Seterusnya ‚Üí
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let selectedYear = null;
        let selectedClass = null;
        let selectedStudent = null;
        let readingData = [];

        // Sample data - dalam implementasi sebenar, data ini akan datang dari Google Sheets
        let sampleStudents = {};

async function fetchStudentList() {
    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbxRKwh4PEynTd_mJnu3iYiBadhN7tVlghAMNaZWUvFxGWRDcsmkTVfLSGIHeWW7aSWZ/exec');
        if (!response.ok) throw new Error('Fetch gagal');
        sampleStudents = await response.json();
    } catch (error) {
        alert('‚ö†Ô∏è Gagal ambil data murid. Sila semak URL atau sambungan internet.');
        console.error('Fetch error:', error);
        sampleStudents = {};
    }
}


        
        // Navigation functions
        function showHome() {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById('home').classList.add('active');
        }

        function loadDashboard() {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.getElementById('dashboard').classList.add('active');

    // Ambil data sebenar dari Google Sheet
    loadDashboardData();
}


        function startWizard() {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById('wizard').classList.add('active');
            resetWizard();
        }

        // Wizard functions
        function resetWizard() {
            currentStep = 1;
            selectedYear = null;
            selectedClass = null;
            selectedStudent = null;
            
            // Reset step indicators
            document.querySelectorAll('.step-dot').forEach(dot => {
                dot.classList.remove('active', 'completed');
            });
            document.getElementById('step1').classList.add('active');
            
            // Reset wizard steps
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.style.display = 'none';
            });
            document.getElementById('wizardStep1').style.display = 'block';
            document.getElementById('wizardStep4').innerHTML = `
    <h2>Maklumat Buku</h2>
    <div class="form-group">
        <label for="bookTitle">Tajuk Buku:</label>
        <input type="text" id="bookTitle" placeholder="Masukkan tajuk buku">
    </div>
    <div class="form-group">
        <label for="bookAuthor">Pengarang:</label>
        <input type="text" id="bookAuthor" placeholder="Masukkan nama pengarang">
    </div>
    <div class="form-group">
        <label for="bookCategory">Kategori:</label>
        <select id="bookCategory">
            <option value="">-- Pilih Kategori --</option>
            <option value="Fiksyen">Fiksyen</option>
            <option value="Bukan Fiksyen">Bukan Fiksyen</option>
        </select>
    </div>
    <div class="form-group">
        <label for="readingDate">Tarikh Bacaan:</label>
        <input type="date" id="readingDate">
    </div>
    <div class="form-group">
        <label for="bookReview">Ulasan / Sinopsis:</label>
        <textarea id="bookReview" rows="4" placeholder="Tulis ulasan atau sinopsis buku"></textarea>
    </div>
    <button class="btn btn-add" onclick="submitReading()" style="width: 100%; margin-top: 20px;">
        ‚úÖ Hantar Bacaan
    </button>
`;

            // Reset buttons
            document.querySelectorAll('.btn-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            updateNavigationButtons();
        }

        function selectYear(year) {
            selectedYear = year;
            document.querySelectorAll('#wizardStep1 .btn-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            setTimeout(() => {
                nextStep();
            }, 500);
        }

        function selectClass(className) {
            selectedClass = className;
            document.querySelectorAll('#wizardStep2 .btn-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Populate students for selected year and class
            populateStudents();
            
            setTimeout(() => {
                nextStep();
            }, 500);
        }

        function populateStudents() {
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">-- Pilih Murid --</option>';
            
            if (selectedYear && selectedClass && sampleStudents[selectedYear] && sampleStudents[selectedYear][selectedClass]) {
                sampleStudents[selectedYear][selectedClass].forEach(student => {
                    const option = document.createElement('option');
                    option.value = student;
                    option.textContent = student;
                    studentSelect.appendChild(option);
                });
            }
        }

        function selectStudent() {
            selectedStudent = document.getElementById('studentSelect').value;
            if (selectedStudent) {
                setTimeout(() => {
                    nextStep();
                }, 500);
            }
        }

        function nextStep() {
            if (currentStep < 4) {
                // Hide current step
                document.getElementById(`wizardStep${currentStep}`).style.display = 'none';
                
                // Mark current step as completed
                document.getElementById(`step${currentStep}`).classList.remove('active');
                document.getElementById(`step${currentStep}`).classList.add('completed');
                
                // Show next step
                currentStep++;
                document.getElementById(`wizardStep${currentStep}`).style.display = 'block';
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                updateNavigationButtons();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                // Hide current step
                document.getElementById(`wizardStep${currentStep}`).style.display = 'none';
                document.getElementById(`step${currentStep}`).classList.remove('active');
                
                // Show previous step
                currentStep--;
                document.getElementById(`wizardStep${currentStep}`).style.display = 'block';
                document.getElementById(`step${currentStep}`).classList.remove('completed');
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                updateNavigationButtons();
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (currentStep === 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else if (currentStep === 4) {
                prevBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'inline-block';
                nextBtn.style.display = 'inline-block';
            }
        }

        // Submit reading function
        function submitReading() {
            const bookTitle = document.getElementById('bookTitle').value;
            const bookAuthor = document.getElementById('bookAuthor').value;
            const bookCategory = document.getElementById('bookCategory').value;
            const readingDate = document.getElementById('readingDate').value;
            const bookReview = document.getElementById('bookReview').value;
            
            // Validation
            if (!bookTitle || !bookAuthor || !bookCategory || !readingDate || !bookReview) {
                alert('Sila lengkapkan semua maklumat buku!');
                return;
            }

            // Prepare data for submission
            const readingEntry = {
                year: selectedYear,
                class: selectedClass,
                student: selectedStudent,
                bookTitle: bookTitle,
                bookAuthor: bookAuthor,
                bookCategory: bookCategory,
                readingDate: readingDate,
                bookReview: bookReview,
                timestamp: new Date().toISOString()
            };
            
            // Show loading
            showLoading();
            
           submitToGoogleSheet(readingEntry);

        }
        
        // Show loading state
        function showLoading() {
            const wizardStep4 = document.getElementById('wizardStep4');
            wizardStep4.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Menghantar data...</p>
                </div>
            `;
        }
        
        // Show success message
        function showSuccess(data) {
    const wizardStep4 = document.getElementById('wizardStep4');
    wizardStep4.innerHTML = `
        <div class="success-message">
            <h2>‚úÖ Berjaya!</h2>
            <p>Bacaan telah berjaya direkodkan.</p>
            <p><strong>Murid:</strong> ${data.student}</p>
            <p><strong>Buku:</strong> ${data.bookTitle}</p>
        </div>
    `;
}

        
        // Reset form
        function resetForm() {
            document.getElementById('bookTitle').value = '';
            document.getElementById('bookAuthor').value = '';
            document.getElementById('bookCategory').value = '';
            document.getElementById('readingDate').value = '';
            document.getElementById('bookReview').value = '';
        }
        
        // Dashboard functions
        function updateDashboardStats() {
            const totalBooks = sampleReadingData.reduce((sum, entry) => sum + entry.books, 0);
            const totalStudents = sampleReadingData.length;
            const totalClasses = new Set(sampleReadingData.map(entry => `${entry.year}-${entry.class}`)).size;
            
            document.getElementById('totalBooks').textContent = totalBooks;
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalClasses').textContent = totalClasses;
        }
        
        function updateRankingList() {
            const rankingList = document.getElementById('rankingList');
            
            // Sort by book count
            const sortedData = [...sampleReadingData].sort((a, b) => b.books - a.books);
            
            rankingList.innerHTML = '';
            sortedData.slice(0, 10).forEach((entry, index) => {
                const rankingItem = document.createElement('div');
                rankingItem.className = 'ranking-item';
                
                let positionClass = '';
                if (index === 0) positionClass = 'gold';
                else if (index === 1) positionClass = 'silver';
                else if (index === 2) positionClass = 'bronze';
                
                rankingItem.innerHTML = `
                    <div class="ranking-position ${positionClass}">${index + 1}</div>
                    <div class="student-info">
                        <div class="student-name">${entry.student}</div>
                        <div class="student-class">Tahun ${entry.year} ${entry.class}</div>
                    </div>
                    <div class="book-count">${entry.books}</div>
                `;
                
                rankingList.appendChild(rankingItem);
            });
        }
        
        function updateClassList() {
            const classList = document.getElementById('classList');
            
            // Group by year and class
            const groupedData = {};
            sampleReadingData.forEach(entry => {
                const key = `${entry.year}-${entry.class}`;
                if (!groupedData[key]) {
                    groupedData[key] = [];
                }
                groupedData[key].push(entry);
            });
            
            classList.innerHTML = '';
            Object.keys(groupedData).sort().forEach(key => {
                const [year, className] = key.split('-');
                const classData = groupedData[key];
                
                const classSection = document.createElement('div');
                classSection.style.marginBottom = '20px';
                
                const classHeader = document.createElement('h3');
                classHeader.textContent = `Tahun ${year} ${className}`;
                classHeader.style.color = '#ff8300';
                classHeader.style.marginBottom = '10px';
                classSection.appendChild(classHeader);
                
                classData.forEach(entry => {
                    const studentItem = document.createElement('div');
                    studentItem.className = 'ranking-item';
                    studentItem.innerHTML = `
                        <div class="student-info">
                            <div class="student-name">${entry.student}</div>
                        </div>
                        <div class="book-count">${entry.books}</div>
                    `;
                    classSection.appendChild(studentItem);
                });
                
                classList.appendChild(classSection);
            });
        }
        
        // Google Sheets integration (placeholder)
        function submitToGoogleSheet(data) {
  const scriptURL = 'https://script.google.com/macros/s/AKfycbxRKwh4PEynTd_mJnu3iYiBadhN7tVlghAMNaZWUvFxGWRDcsmkTVfLSGIHeWW7aSWZ/exec';

  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(data),
    mode: 'no-cors'
  });

  // üëâ Terus tunjuk mesej BERJAYA tanpa tunggu response
  showSuccess(data);
  resetForm();
  setTimeout(showHome, 2000);
}
function loadDashboardData() {
  const url = 'https://script.google.com/macros/s/AKfycbxRKwh4PEynTd_mJnu3iYiBadhN7tVlghAMNaZWUvFxGWRDcsmkTVfLSGIHeWW7aSWZ/exec?dashboard=1';

  fetch(url)
    .then(res => res.json())
    .then(data => {
      showDashboardStats(data);
      showTopReaders(data);
      showGroupedByClass(data);
    })
    .catch(err => {
      console.error("Gagal ambil data:", err);
    });
}

function showDashboardStats(data) {
  const totalBooks = data.length;
  const totalStudents = new Set(data.map(entry => entry.Nama)).size;
  const totalClasses = new Set(data.map(entry => `${entry.Tahun}-${entry.Kelas}`)).size;

  document.getElementById('totalBooks').textContent = totalBooks;
  document.getElementById('totalStudents').textContent = totalStudents;
  document.getElementById('totalClasses').textContent = totalClasses;
}

function showTopReaders(data) {
  const rankingList = document.getElementById('rankingList');
  const readerMap = {};

  data.forEach(entry => {
    const key = `${entry.Nama}-${entry.Tahun}-${entry.Kelas}`;
    if (!readerMap[key]) {
      readerMap[key] = {
        Nama: entry.Nama,
        Tahun: entry.Tahun,
        Kelas: entry.Kelas,
        count: 0
      };
    }
    readerMap[key].count++;
  });

  const sorted = Object.values(readerMap).sort((a, b) => b.count - a.count);
  rankingList.innerHTML = '';

  sorted.slice(0, 10).forEach((reader, index) => {
    let medal = '';
    if (index === 0) medal = 'gold';
    else if (index === 1) medal = 'silver';
    else if (index === 2) medal = 'bronze';

    const item = document.createElement('div');
    item.className = 'ranking-item';
    item.innerHTML = `
      <div class="ranking-position ${medal}">${index + 1}</div>
      <div class="student-info">
        <div class="student-name">${reader.Nama}</div>
        <div class="student-class">Tahun ${reader.Tahun} ${reader.Kelas}</div>
      </div>
      <div class="book-count">${reader.count}</div>
    `;
    rankingList.appendChild(item);
  });
}

function showGroupedByClass(data) {
  const classList = document.getElementById('classList');
  const grouped = {};

  data.forEach(entry => {
    const key = `${entry.Tahun}-${entry.Kelas}`;
    if (!grouped[key]) grouped[key] = {};
    
    const studentKey = entry.Nama;
    if (!grouped[key][studentKey]) {
      grouped[key][studentKey] = 0;
    }
    grouped[key][studentKey]++;
  });

  classList.innerHTML = '';

  Object.keys(grouped).sort().forEach(key => {
    const [tahun, kelas] = key.split('-');
    const section = document.createElement('div');
    section.style.marginBottom = '20px';

    const title = document.createElement('h3');
    title.textContent = `Tahun ${tahun} ${kelas}`;
    title.style.color = '#ff8300';
    section.appendChild(title);

    Object.entries(grouped[key]).forEach(([nama, jumlah]) => {
      const item = document.createElement('div');
      item.className = 'ranking-item';
      item.innerHTML = `
        <div class="student-info">
          <div class="student-name">${nama}</div>
        </div>
        <div class="book-count">${jumlah}</div>
      `;
      section.appendChild(item);
    });

    classList.appendChild(section);
  });
}
        
        function showError(message) {
            const wizardStep4 = document.getElementById('wizardStep4');
            wizardStep4.innerHTML = `
                <div class="error-message">
                    <h2>‚ùå Ralat</h2>
                    <p>${message}</p>
                    <button class="btn btn-add" onclick="location.reload()" style="margin-top: 15px;">
                        Cuba Lagi
                    </button>
                </div>
            `;
        }
        
        // Auto-set today's date
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('readingDate').value = today;
        }
        
        // Initialize app
       document.addEventListener('DOMContentLoaded', async function () {
    await fetchStudentList();
            // Set today's date as default
            setTodayDate();
        });
        
        // Touch and swipe gestures for mobile
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
        
        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left - next step
                    if (currentStep < 4 && document.getElementById('wizard').classList.contains('active')) {
                        nextStep();
                    }
                } else {
                    // Swipe right - previous step
                    if (currentStep > 1 && document.getElementById('wizard').classList.contains('active')) {
                        previousStep();
                    }
                }
            }
        }
        
        // Auto-save to local storage (backup)
        function saveToLocalStorage(data) {
            const existingData = JSON.parse(localStorage.getItem('nisaReadingData') || '[]');
            existingData.push(data);
            localStorage.setItem('nisaReadingData', JSON.stringify(existingData));
        }
        
        // Load from local storage
        function loadFromLocalStorage() {
            const data = JSON.parse(localStorage.getItem('nisaReadingData') || '[]');
            return data;
        }
        
        // Offline support
        function isOnline() {
            return navigator.onLine;
        }
        
        // Show offline indicator
        function showOfflineIndicator() {
            if (!isOnline()) {
                const indicator = document.createElement('div');
                indicator.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #ff6b6b;
                    color: white;
                    text-align: center;
                    padding: 10px;
                    z-index: 1000;
                `;
                indicator.textContent = 'üì° Aplikasi dalam mod luar talian';
                document.body.appendChild(indicator);
            }
        }
        
        // Check connection status
        window.addEventListener('online', function() {
            location.reload();
        });
        
        window.addEventListener('offline', function() {
            showOfflineIndicator();
        });
        
        // Service worker for offline support (basic)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // Animate on scroll
        function animateOnScroll() {
            const elements = document.querySelectorAll('.ranking-item, .stat-card');
            elements.forEach(element => {
                const elementTop = element.getBoundingClientRect().top;
                const elementVisible = 150;
                
                if (elementTop < window.innerHeight - elementVisible) {
                    element.style.opacity = '1';
                    element.style.transform = 'translateY(0)';
                }
            });
        }
        
        // Initialize animations
        function initializeAnimations() {
            const elements = document.querySelectorAll('.ranking-item, .stat-card');
            elements.forEach(element => {
                element.style.opacity = '0';
                element.style.transform = 'translateY(20px)';
                element.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            });
        }
        
        // Call animations on scroll
        window.addEventListener('scroll', animateOnScroll);
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeAnimations();
            setTimeout(animateOnScroll, 100);
        });
        
    </script>
</body>
</html>